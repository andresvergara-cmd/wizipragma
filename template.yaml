AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31

Description: >
  CENTLI - Multimodal Banking Assistant Hackathon
  Complete infrastructure for AgentCore, Action Groups, and Frontend

Metadata:
  AWS::ServerlessRepo::Application:
    Name: centli-hackathon
    Description: Multimodal banking assistant with AWS Bedrock AgentCore
    Author: CENTLI Team
    Labels: ['bedrock', 'agentcore', 'banking', 'multimodal']

Globals:
  Function:
    Runtime: python3.11
    Timeout: 30
    MemorySize: 512
    Environment:
      Variables:
        EVENT_BUS_NAME: centli-event-bus
        ASSETS_BUCKET_NAME: !Ref CentliAssetsBucket
        LOG_LEVEL: !Ref LogLevel
        AWS_ACCOUNT_ID: !Ref AWS::AccountId
    Tags:
      Project: CENTLI
      Environment: !Ref Environment

Parameters:
  Environment:
    Type: String
    Default: hackathon
    Description: Environment name (hackathon, dev, prod)
    AllowedValues:
      - hackathon
      - dev
      - prod
  
  LogLevel:
    Type: String
    Default: INFO
    Description: CloudWatch log level for Lambda functions
    AllowedValues:
      - DEBUG
      - INFO
      - WARN
      - ERROR

Resources:
  # ============================================================================
  # UNIT 1: INFRASTRUCTURE FOUNDATION
  # ============================================================================
  
  # EventBridge Event Bus for event-driven communication
  CentliEventBus:
    Type: AWS::Events::EventBus
    Properties:
      Name: centli-event-bus
      Tags:
        - Key: Project
          Value: CENTLI
        - Key: Environment
          Value: !Ref Environment
        - Key: Unit
          Value: Infrastructure Foundation
  
  # S3 Bucket for images and static assets
  CentliAssetsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub 'centli-assets-${AWS::AccountId}'
      CorsConfiguration:
        CorsRules:
          - AllowedOrigins:
              - 'http://localhost:3000'
              - 'http://localhost:8080'
              - 'http://127.0.0.1:*'
            AllowedMethods:
              - GET
              - PUT
              - POST
              - DELETE
            AllowedHeaders:
              - '*'
            MaxAge: 3600
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: Project
          Value: CENTLI
        - Key: Environment
          Value: !Ref Environment
        - Key: Unit
          Value: Infrastructure Foundation
  
  # S3 Bucket Policy for Lambda access
  CentliAssetsBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref CentliAssetsBucket
      PolicyDocument:
        Statement:
          - Sid: AllowLambdaAccess
            Effect: Allow
            Principal:
              AWS: !GetAtt CentliLambdaExecutionRole.Arn
            Action:
              - 's3:GetObject'
              - 's3:PutObject'
              - 's3:DeleteObject'
            Resource: !Sub '${CentliAssetsBucket.Arn}/*'
  
  # IAM Role for Lambda execution with all required permissions
  CentliLambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: CentliLambdaExecutionRole
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: 'sts:AssumeRole'
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        # EventBridge permissions
        - PolicyName: CentliEventBridgePolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - 'events:PutEvents'
                Resource: !GetAtt CentliEventBus.Arn
        
        # DynamoDB permissions
        - PolicyName: CentliDynamoDBPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - 'dynamodb:GetItem'
                  - 'dynamodb:PutItem'
                  - 'dynamodb:UpdateItem'
                  - 'dynamodb:DeleteItem'
                  - 'dynamodb:Query'
                  - 'dynamodb:Scan'
                  - 'dynamodb:BatchGetItem'
                  - 'dynamodb:BatchWriteItem'
                Resource:
                  - !Sub 'arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/centli-*'
                  - !Sub 'arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/centli-*/index/*'
        
        # S3 permissions
        - PolicyName: CentliS3Policy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - 's3:GetObject'
                  - 's3:PutObject'
                  - 's3:DeleteObject'
                  - 's3:ListBucket'
                Resource:
                  - !GetAtt CentliAssetsBucket.Arn
                  - !Sub '${CentliAssetsBucket.Arn}/*'
        
        # Bedrock permissions
        - PolicyName: CentliBedrockPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - 'bedrock:InvokeModel'
                  - 'bedrock:InvokeAgent'
                  - 'bedrock:Retrieve'
                  - 'bedrock:InvokeModelWithResponseStream'
                Resource:
                  - !Sub 'arn:aws:bedrock:${AWS::Region}::foundation-model/*'
                  - !Sub 'arn:aws:bedrock:${AWS::Region}:${AWS::AccountId}:agent/*'
                  - !Sub 'arn:aws:bedrock:${AWS::Region}:${AWS::AccountId}:agent-alias/*'
                  - !Sub 'arn:aws:bedrock:${AWS::Region}:${AWS::AccountId}:knowledge-base/*'
        
        # API Gateway permissions for WebSocket
        - PolicyName: CentliAPIGatewayPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - 'execute-api:ManageConnections'
                  - 'execute-api:Invoke'
                Resource: !Sub 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:*/@connections/*'
      Tags:
        - Key: Project
          Value: CENTLI
        - Key: Environment
          Value: !Ref Environment
        - Key: Unit
          Value: Infrastructure Foundation
  
  # CloudWatch Log Group for centralized logging
  CentliLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: /aws/lambda/centli
      RetentionInDays: 7
      Tags:
        - Key: Project
          Value: CENTLI
        - Key: Environment
          Value: !Ref Environment
        - Key: Unit
          Value: Infrastructure Foundation

  # ============================================================================
  # UNIT 2: AGENTCORE & ORCHESTRATION
  # ============================================================================
  
  # WebSocket API for real-time communication
  CentliWebSocketAPI:
    Type: AWS::ApiGatewayV2::Api
    Properties:
      Name: centli-websocket-api
      ProtocolType: WEBSOCKET
      RouteSelectionExpression: $request.body.action
      Tags:
        Project: CENTLI
        Environment: !Ref Environment
        Unit: AgentCoreOrchestration
  
  # WebSocket Stage
  CentliWebSocketStage:
    Type: AWS::ApiGatewayV2::Stage
    Properties:
      ApiId: !Ref CentliWebSocketAPI
      StageName: prod
      AutoDeploy: true
      DefaultRouteSettings:
        ThrottlingBurstLimit: 100
        ThrottlingRateLimit: 50
      Tags:
        Project: CENTLI
        Environment: !Ref Environment
  
  # DynamoDB Sessions Table
  CentliSessionsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: centli-sessions
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: session_id
          AttributeType: S
        - AttributeName: user_id
          AttributeType: S
      KeySchema:
        - AttributeName: session_id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: user-index
          KeySchema:
            - AttributeName: user_id
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: expires_at
        Enabled: true
      SSESpecification:
        SSEEnabled: true
      Tags:
        - Key: Project
          Value: CENTLI
        - Key: Environment
          Value: !Ref Environment
        - Key: Unit
          Value: AgentCoreOrchestration
  
  # Lambda Function: Connect Handler
  ConnectFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: centli-app-connect
      CodeUri: src_aws/app_connect/
      Handler: app_connect.lambda_handler
      Role: !GetAtt CentliLambdaExecutionRole.Arn
      Environment:
        Variables:
          SESSIONS_TABLE: !Ref CentliSessionsTable
      Tags:
        Unit: AgentCoreOrchestration
  
  # Lambda Function: Disconnect Handler
  DisconnectFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: centli-app-disconnect
      CodeUri: src_aws/app_disconnect/
      Handler: app_disconnect.lambda_handler
      Role: !GetAtt CentliLambdaExecutionRole.Arn
      Environment:
        Variables:
          SESSIONS_TABLE: !Ref CentliSessionsTable
      Tags:
        Unit: AgentCoreOrchestration
  
  # Lambda Function: Message Handler
  MessageFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: centli-app-message
      CodeUri: src_aws/app_message/
      Handler: app_message.lambda_handler
      Role: !GetAtt CentliLambdaExecutionRole.Arn
      Environment:
        Variables:
          SESSIONS_TABLE: !Ref CentliSessionsTable
          EVENT_BUS_NAME: !Ref CentliEventBus
          AGENTCORE_ID: ''  # To be updated after Bedrock Agent creation
          ASSETS_BUCKET: !Ref CentliAssetsBucket
      Tags:
        Unit: AgentCoreOrchestration
  
  # WebSocket Routes and Integrations
  ConnectRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref CentliWebSocketAPI
      RouteKey: $connect
      AuthorizationType: NONE
      Target: !Sub integrations/${ConnectIntegration}
  
  DisconnectRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref CentliWebSocketAPI
      RouteKey: $disconnect
      Target: !Sub integrations/${DisconnectIntegration}
  
  DefaultRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref CentliWebSocketAPI
      RouteKey: $default
      Target: !Sub integrations/${MessageIntegration}
  
  ConnectIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref CentliWebSocketAPI
      IntegrationType: AWS_PROXY
      IntegrationUri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${ConnectFunction.Arn}/invocations
  
  DisconnectIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref CentliWebSocketAPI
      IntegrationType: AWS_PROXY
      IntegrationUri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${DisconnectFunction.Arn}/invocations
  
  MessageIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref CentliWebSocketAPI
      IntegrationType: AWS_PROXY
      IntegrationUri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${MessageFunction.Arn}/invocations
  
  # Lambda Permissions for API Gateway
  ConnectPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref ConnectFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${CentliWebSocketAPI}/*
  
  DisconnectPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref DisconnectFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${CentliWebSocketAPI}/*
  
  MessagePermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref MessageFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${CentliWebSocketAPI}/*

  # ============================================================================
  # UNIT 3: ACTION GROUPS
  # ============================================================================
  
  # ----------------------------------------------------------------------------
  # DynamoDB Tables
  # ----------------------------------------------------------------------------
  
  # Core Banking - Accounts Table
  CentliAccountsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: centli-accounts
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: user_id
          AttributeType: S
        - AttributeName: account_id
          AttributeType: S
      KeySchema:
        - AttributeName: user_id
          KeyType: HASH
        - AttributeName: account_id
          KeyType: RANGE
      SSESpecification:
        SSEEnabled: true
      Tags:
        - Key: Project
          Value: CENTLI
        - Key: Environment
          Value: !Ref Environment
        - Key: Unit
          Value: ActionGroups
        - Key: ActionGroup
          Value: CoreBanking
  
  # Core Banking - Transactions Table
  CentliTransactionsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: centli-transactions
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: account_id
          AttributeType: S
        - AttributeName: timestamp_txn_id
          AttributeType: S
        - AttributeName: user_id
          AttributeType: S
      KeySchema:
        - AttributeName: account_id
          KeyType: HASH
        - AttributeName: timestamp_txn_id
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: user-index
          KeySchema:
            - AttributeName: user_id
              KeyType: HASH
            - AttributeName: timestamp_txn_id
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      SSESpecification:
        SSEEnabled: true
      Tags:
        - Key: Project
          Value: CENTLI
        - Key: Environment
          Value: !Ref Environment
        - Key: Unit
          Value: ActionGroups
        - Key: ActionGroup
          Value: CoreBanking
  
  # Marketplace - Products Table
  CentliProductsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: centli-products
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: product_id
          AttributeType: S
        - AttributeName: retailer_id
          AttributeType: S
      KeySchema:
        - AttributeName: product_id
          KeyType: HASH
        - AttributeName: retailer_id
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: retailer-index
          KeySchema:
            - AttributeName: retailer_id
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      SSESpecification:
        SSEEnabled: true
      Tags:
        - Key: Project
          Value: CENTLI
        - Key: Environment
          Value: !Ref Environment
        - Key: Unit
          Value: ActionGroups
        - Key: ActionGroup
          Value: Marketplace
  
  # Marketplace - Purchases Table
  CentliPurchasesTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: centli-purchases
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: user_id
          AttributeType: S
        - AttributeName: timestamp_purchase_id
          AttributeType: S
      KeySchema:
        - AttributeName: user_id
          KeyType: HASH
        - AttributeName: timestamp_purchase_id
          KeyType: RANGE
      SSESpecification:
        SSEEnabled: true
      Tags:
        - Key: Project
          Value: CENTLI
        - Key: Environment
          Value: !Ref Environment
        - Key: Unit
          Value: ActionGroups
        - Key: ActionGroup
          Value: Marketplace
  
  # Marketplace - Retailers Table
  CentliRetailersTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: centli-retailers
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: retailer_id
          AttributeType: S
      KeySchema:
        - AttributeName: retailer_id
          KeyType: HASH
      SSESpecification:
        SSEEnabled: true
      Tags:
        - Key: Project
          Value: CENTLI
        - Key: Environment
          Value: !Ref Environment
        - Key: Unit
          Value: ActionGroups
        - Key: ActionGroup
          Value: Marketplace
  
  # CRM - Beneficiaries Table
  CentliBeneficiariesTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: centli-beneficiaries
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: user_id
          AttributeType: S
        - AttributeName: beneficiary_id
          AttributeType: S
        - AttributeName: alias_lower
          AttributeType: S
      KeySchema:
        - AttributeName: user_id
          KeyType: HASH
        - AttributeName: beneficiary_id
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: alias-index
          KeySchema:
            - AttributeName: alias_lower
              KeyType: HASH
            - AttributeName: user_id
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      SSESpecification:
        SSEEnabled: true
      Tags:
        - Key: Project
          Value: CENTLI
        - Key: Environment
          Value: !Ref Environment
        - Key: Unit
          Value: ActionGroups
        - Key: ActionGroup
          Value: CRM
  
  # ----------------------------------------------------------------------------
  # Lambda Functions - Core Banking
  # ----------------------------------------------------------------------------
  
  # Core Banking - Balance Query
  CoreBankingBalanceFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: centli-core-banking-balance
      CodeUri: src_aws/core_banking_balance/
      Handler: balance.lambda_handler
      Role: !GetAtt CentliLambdaExecutionRole.Arn
      Environment:
        Variables:
          ACCOUNTS_TABLE: !Ref CentliAccountsTable
      Tags:
        Unit: ActionGroups
        ActionGroup: CoreBanking
      Events:
        BalanceQuery:
          Type: EventBridgeRule
          Properties:
            EventBusName: !Ref CentliEventBus
            Pattern:
              detail-type:
                - BALANCE_QUERY
  
  # Core Banking - Transfer
  CoreBankingTransferFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: centli-core-banking-transfer
      CodeUri: src_aws/core_banking_transfer/
      Handler: transfer.lambda_handler
      Role: !GetAtt CentliLambdaExecutionRole.Arn
      Environment:
        Variables:
          ACCOUNTS_TABLE: !Ref CentliAccountsTable
          TRANSACTIONS_TABLE: !Ref CentliTransactionsTable
      Tags:
        Unit: ActionGroups
        ActionGroup: CoreBanking
      Events:
        TransferRequest:
          Type: EventBridgeRule
          Properties:
            EventBusName: !Ref CentliEventBus
            Pattern:
              detail-type:
                - TRANSFER_REQUEST
                - PAYMENT_REQUEST
  
  # Core Banking - Transactions Query
  CoreBankingTransactionsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: centli-core-banking-transactions
      CodeUri: src_aws/core_banking_transactions/
      Handler: transactions.lambda_handler
      Role: !GetAtt CentliLambdaExecutionRole.Arn
      Environment:
        Variables:
          TRANSACTIONS_TABLE: !Ref CentliTransactionsTable
      Tags:
        Unit: ActionGroups
        ActionGroup: CoreBanking
      Events:
        TransactionsQuery:
          Type: EventBridgeRule
          Properties:
            EventBusName: !Ref CentliEventBus
            Pattern:
              detail-type:
                - TRANSACTIONS_QUERY
  
  # ----------------------------------------------------------------------------
  # Lambda Functions - Marketplace
  # ----------------------------------------------------------------------------
  
  # Marketplace - Catalog Query
  MarketplaceCatalogFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: centli-marketplace-catalog
      CodeUri: src_aws/marketplace_catalog/
      Handler: catalog.lambda_handler
      Role: !GetAtt CentliLambdaExecutionRole.Arn
      Environment:
        Variables:
          PRODUCTS_TABLE: !Ref CentliProductsTable
          RETAILERS_TABLE: !Ref CentliRetailersTable
      Tags:
        Unit: ActionGroups
        ActionGroup: Marketplace
      Events:
        CatalogQuery:
          Type: EventBridgeRule
          Properties:
            EventBusName: !Ref CentliEventBus
            Pattern:
              detail-type:
                - CATALOG_QUERY
  
  # Marketplace - Benefits Query
  MarketplaceBenefitsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: centli-marketplace-benefits
      CodeUri: src_aws/marketplace_benefits/
      Handler: benefits.lambda_handler
      Role: !GetAtt CentliLambdaExecutionRole.Arn
      Environment:
        Variables:
          PRODUCTS_TABLE: !Ref CentliProductsTable
      Tags:
        Unit: ActionGroups
        ActionGroup: Marketplace
      Events:
        BenefitsQuery:
          Type: EventBridgeRule
          Properties:
            EventBusName: !Ref CentliEventBus
            Pattern:
              detail-type:
                - BENEFITS_QUERY
  
  # Marketplace - Purchase
  MarketplacePurchaseFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: centli-marketplace-purchase
      CodeUri: src_aws/marketplace_purchase/
      Handler: purchase.lambda_handler
      Role: !GetAtt CentliLambdaExecutionRole.Arn
      Environment:
        Variables:
          PRODUCTS_TABLE: !Ref CentliProductsTable
          PURCHASES_TABLE: !Ref CentliPurchasesTable
      Tags:
        Unit: ActionGroups
        ActionGroup: Marketplace
      Events:
        PurchaseRequest:
          Type: EventBridgeRule
          Properties:
            EventBusName: !Ref CentliEventBus
            Pattern:
              detail-type:
                - PURCHASE_REQUEST
        PaymentCompleted:
          Type: EventBridgeRule
          Properties:
            EventBusName: !Ref CentliEventBus
            Pattern:
              detail-type:
                - PAYMENT_COMPLETED
        PaymentFailed:
          Type: EventBridgeRule
          Properties:
            EventBusName: !Ref CentliEventBus
            Pattern:
              detail-type:
                - PAYMENT_FAILED
  
  # ----------------------------------------------------------------------------
  # Lambda Functions - CRM
  # ----------------------------------------------------------------------------
  
  # CRM - Resolve Alias
  CRMResolveAliasFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: centli-crm-resolve-alias
      CodeUri: src_aws/crm_resolve_alias/
      Handler: resolve_alias.lambda_handler
      Role: !GetAtt CentliLambdaExecutionRole.Arn
      Environment:
        Variables:
          BENEFICIARIES_TABLE: !Ref CentliBeneficiariesTable
      Tags:
        Unit: ActionGroups
        ActionGroup: CRM
      Events:
        AliasResolution:
          Type: EventBridgeRule
          Properties:
            EventBusName: !Ref CentliEventBus
            Pattern:
              detail-type:
                - ALIAS_RESOLUTION_REQUEST
  
  # CRM - Get Beneficiaries
  CRMGetBeneficiariesFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: centli-crm-get-beneficiaries
      CodeUri: src_aws/crm_get_beneficiaries/
      Handler: get_beneficiaries.lambda_handler
      Role: !GetAtt CentliLambdaExecutionRole.Arn
      Environment:
        Variables:
          BENEFICIARIES_TABLE: !Ref CentliBeneficiariesTable
      Tags:
        Unit: ActionGroups
        ActionGroup: CRM
      Events:
        BeneficiariesQuery:
          Type: EventBridgeRule
          Properties:
            EventBusName: !Ref CentliEventBus
            Pattern:
              detail-type:
                - BENEFICIARIES_QUERY
  
  # CRM - Add Beneficiary
  CRMAddBeneficiaryFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: centli-crm-add-beneficiary
      CodeUri: src_aws/crm_add_beneficiary/
      Handler: add_beneficiary.lambda_handler
      Role: !GetAtt CentliLambdaExecutionRole.Arn
      Environment:
        Variables:
          BENEFICIARIES_TABLE: !Ref CentliBeneficiariesTable
      Tags:
        Unit: ActionGroups
        ActionGroup: CRM
      Events:
        AddBeneficiary:
          Type: EventBridgeRule
          Properties:
            EventBusName: !Ref CentliEventBus
            Pattern:
              detail-type:
                - ADD_BENEFICIARY_REQUEST

  # ============================================================================
  # UNIT 4: FRONTEND
  # (To be added in Unit 4 code generation)
  # ============================================================================

Outputs:
  # Unit 1 Outputs - Shared Infrastructure
  EventBusArn:
    Description: EventBridge Event Bus ARN for event-driven communication
    Value: !GetAtt CentliEventBus.Arn
    Export:
      Name: !Sub '${AWS::StackName}-EventBusArn'
  
  EventBusName:
    Description: EventBridge Event Bus Name
    Value: !Ref CentliEventBus
    Export:
      Name: !Sub '${AWS::StackName}-EventBusName'
  
  AssetsBucketName:
    Description: S3 Assets Bucket Name for images and static files
    Value: !Ref CentliAssetsBucket
    Export:
      Name: !Sub '${AWS::StackName}-AssetsBucketName'
  
  AssetsBucketArn:
    Description: S3 Assets Bucket ARN
    Value: !GetAtt CentliAssetsBucket.Arn
    Export:
      Name: !Sub '${AWS::StackName}-AssetsBucketArn'
  
  LambdaExecutionRoleArn:
    Description: Lambda Execution Role ARN for all Lambda functions
    Value: !GetAtt CentliLambdaExecutionRole.Arn
    Export:
      Name: !Sub '${AWS::StackName}-LambdaExecutionRoleArn'
  
  LogGroupName:
    Description: CloudWatch Log Group Name for centralized logging
    Value: !Ref CentliLogGroup
    Export:
      Name: !Sub '${AWS::StackName}-LogGroupName'
  
  StackName:
    Description: CloudFormation Stack Name
    Value: !Ref AWS::StackName
  
  Region:
    Description: AWS Region
    Value: !Ref AWS::Region
  
  AccountId:
    Description: AWS Account ID
    Value: !Ref AWS::AccountId
  
  # Unit 2 Outputs - AgentCoreOrchestration
  WebSocketURL:
    Description: WebSocket API URL for real-time communication
    Value: !Sub 'wss://${CentliWebSocketAPI}.execute-api.${AWS::Region}.amazonaws.com/prod'
    Export:
      Name: !Sub '${AWS::StackName}-WebSocketURL'
  
  WebSocketAPIId:
    Description: WebSocket API ID
    Value: !Ref CentliWebSocketAPI
    Export:
      Name: !Sub '${AWS::StackName}-WebSocketAPIId'
  
  SessionsTableName:
    Description: DynamoDB Sessions Table Name
    Value: !Ref CentliSessionsTable
    Export:
      Name: !Sub '${AWS::StackName}-SessionsTableName'
  
  SessionsTableArn:
    Description: DynamoDB Sessions Table ARN
    Value: !GetAtt CentliSessionsTable.Arn
    Export:
      Name: !Sub '${AWS::StackName}-SessionsTableArn'
  
  ConnectFunctionArn:
    Description: Connect Lambda Function ARN
    Value: !GetAtt ConnectFunction.Arn
    Export:
      Name: !Sub '${AWS::StackName}-ConnectFunctionArn'
  
  DisconnectFunctionArn:
    Description: Disconnect Lambda Function ARN
    Value: !GetAtt DisconnectFunction.Arn
    Export:
      Name: !Sub '${AWS::StackName}-DisconnectFunctionArn'
  
  MessageFunctionArn:
    Description: Message Lambda Function ARN
    Value: !GetAtt MessageFunction.Arn
    Export:
      Name: !Sub '${AWS::StackName}-MessageFunctionArn'
  
  # Unit 3 Outputs - Action Groups
  
  # DynamoDB Tables
  AccountsTableName:
    Description: Core Banking Accounts Table Name
    Value: !Ref CentliAccountsTable
    Export:
      Name: !Sub '${AWS::StackName}-AccountsTableName'
  
  TransactionsTableName:
    Description: Core Banking Transactions Table Name
    Value: !Ref CentliTransactionsTable
    Export:
      Name: !Sub '${AWS::StackName}-TransactionsTableName'
  
  ProductsTableName:
    Description: Marketplace Products Table Name
    Value: !Ref CentliProductsTable
    Export:
      Name: !Sub '${AWS::StackName}-ProductsTableName'
  
  PurchasesTableName:
    Description: Marketplace Purchases Table Name
    Value: !Ref CentliPurchasesTable
    Export:
      Name: !Sub '${AWS::StackName}-PurchasesTableName'
  
  RetailersTableName:
    Description: Marketplace Retailers Table Name
    Value: !Ref CentliRetailersTable
    Export:
      Name: !Sub '${AWS::StackName}-RetailersTableName'
  
  BeneficiariesTableName:
    Description: CRM Beneficiaries Table Name
    Value: !Ref CentliBeneficiariesTable
    Export:
      Name: !Sub '${AWS::StackName}-BeneficiariesTableName'
  
  # Lambda Functions - Core Banking
  CoreBankingBalanceFunctionArn:
    Description: Core Banking Balance Lambda Function ARN
    Value: !GetAtt CoreBankingBalanceFunction.Arn
    Export:
      Name: !Sub '${AWS::StackName}-CoreBankingBalanceFunctionArn'
  
  CoreBankingTransferFunctionArn:
    Description: Core Banking Transfer Lambda Function ARN
    Value: !GetAtt CoreBankingTransferFunction.Arn
    Export:
      Name: !Sub '${AWS::StackName}-CoreBankingTransferFunctionArn'
  
  CoreBankingTransactionsFunctionArn:
    Description: Core Banking Transactions Lambda Function ARN
    Value: !GetAtt CoreBankingTransactionsFunction.Arn
    Export:
      Name: !Sub '${AWS::StackName}-CoreBankingTransactionsFunctionArn'
  
  # Lambda Functions - Marketplace
  MarketplaceCatalogFunctionArn:
    Description: Marketplace Catalog Lambda Function ARN
    Value: !GetAtt MarketplaceCatalogFunction.Arn
    Export:
      Name: !Sub '${AWS::StackName}-MarketplaceCatalogFunctionArn'
  
  MarketplaceBenefitsFunctionArn:
    Description: Marketplace Benefits Lambda Function ARN
    Value: !GetAtt MarketplaceBenefitsFunction.Arn
    Export:
      Name: !Sub '${AWS::StackName}-MarketplaceBenefitsFunctionArn'
  
  MarketplacePurchaseFunctionArn:
    Description: Marketplace Purchase Lambda Function ARN
    Value: !GetAtt MarketplacePurchaseFunction.Arn
    Export:
      Name: !Sub '${AWS::StackName}-MarketplacePurchaseFunctionArn'
  
  # Lambda Functions - CRM
  CRMResolveAliasFunctionArn:
    Description: CRM Resolve Alias Lambda Function ARN
    Value: !GetAtt CRMResolveAliasFunction.Arn
    Export:
      Name: !Sub '${AWS::StackName}-CRMResolveAliasFunctionArn'
  
  CRMGetBeneficiariesFunctionArn:
    Description: CRM Get Beneficiaries Lambda Function ARN
    Value: !GetAtt CRMGetBeneficiariesFunction.Arn
    Export:
      Name: !Sub '${AWS::StackName}-CRMGetBeneficiariesFunctionArn'
  
  CRMAddBeneficiaryFunctionArn:
    Description: CRM Add Beneficiary Lambda Function ARN
    Value: !GetAtt CRMAddBeneficiaryFunction.Arn
    Export:
      Name: !Sub '${AWS::StackName}-CRMAddBeneficiaryFunctionArn'
